<div class="navbar bg-base-100 shadow-sm">
  <div class="w-full flex flex-row px-2">
    <div class="flex-1">
      <div class="flex flex-row gap-4 items-center">
        <a class="btn btn-ghost text-xl" href="/">First Note</a>
        <div class="flex flex-row gap-2">
          {{!-- <button class="btn" id="user-mnt">User Management</button> --}}
        </div>
      </div>
    </div>
    <div id="auth-guest" class="flex flex-row gap-2 invisible">
      <a class="btn" href="/register">Register</a>
      <a class="btn" href="/login">Login</a>
    </div>

    <div id="auth-user" class="flex flex-row gap-2 items-center hidden invisible">
      <button class="btn" id="btn-add-note" onclick="add_note_modal.showModal()">Add Note</button>
      {{!-- <button class="btn" id="btn-account">Account</button> --}}
      <button id="btn-logout" class="btn btn-outline btn-error">Logout</button>
    </div>
  </div>
</div>

{{>add-note-modal}}

<script>
  function safeParse(json, fallback = null) {
    try { return JSON.parse(json); } catch { return fallback; }
  }

  function getStoredUser() {
    return safeParse(localStorage.getItem('user'));
  }

  function getStoredToken() {
    const raw = localStorage.getItem('token');
    const parsed = safeParse(raw, raw);
    return parsed;
  }

  function isLoggedIn() {
    const t = getStoredToken();
    if (!t) return false;
    if (typeof t === 'string') return t.length > 0;
    return !!(t.accessToken || t.token || t.id_token);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const guest = document.getElementById('auth-guest');
    const user = document.getElementById('auth-user');
    const logoutBtn = document.getElementById('btn-logout');
    const userMntBtn = document.getElementById('user-mnt');
    const roomMntBtn = document.getElementById('room-mnt');
    const accountBtn = document.getElementById('btn-account');

    accountBtn?.addEventListener('click', (e) => {

    });

    const loggedIn = isLoggedIn();
    if (loggedIn) {
      guest?.classList.add('hidden');
      user?.classList.remove('hidden');

      const u = getStoredUser();
      if (u && u.role === 'admin') {
        userMntBtn?.classList.remove('hidden');
        roomMntBtn?.classList.remove('hidden');
      } else {
        userMntBtn?.classList.add('hidden');
        roomMntBtn?.classList.add('hidden');
      }
    } else {
      guest?.classList.remove('hidden');
      user?.classList.add('hidden');
    }

    guest?.classList.remove('invisible');
    user?.classList.remove('invisible');

    logoutBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('user');
      localStorage.removeItem('token');
      if (window.msg?.success) msg.success('Logged out');
      setTimeout(() => window.location.href = '/login', 1000);
    });
  });
</script>